{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/image-cropper.css' %}">
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <style>
        /* Estilos para hover de foto de perfil */
        .profile-photo-container {
            width: 160px;
            height: 160px;
            margin: 0 auto 1rem auto;
            position: relative;
            border-radius: 50%;
            overflow: hidden;
            background-color: #f8f9fa;
            border: 3px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .profile-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            transition: opacity 0.3s ease;
        }

        .profile-photo-placeholder {
            font-size: 3rem;
            color: #6c757d;
            transition: opacity 0.3s ease;
        }

        .photo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
        }

        .profile-photo-container:hover .photo-overlay {
            opacity: 1;
        }

.clickeable-photo:hover {
    transform: scale(1.05);
    opacity: 0.8;
}

.profile-photo-placeholder.clickeable-photo:hover {
    background-color: #e3f2fd !important;
    border: 2px solid #2196f3;
}
/* Ocultar el footer completamente en esta página */
.footer {
    display: none !important;
}

.footer-bottom {
    display: none !important;
}

        @media (max-width: 576px) {
            .profile-photo-container {
                width: 120px;
                height: 120px;
            }

            .profile-photo-placeholder {
                font-size: 3rem;
            }
        }
        /* Espaciado responsive */
        .empty-icon {
            font-size: 2.5rem !important;
            color: #6c757d;
        }

        @media (max-width: 576px) {
            .empty-icon {
                font-size: 2rem !important;
            }
        }

        /* Estilos del CV integrado */
        .cv-container {
            max-width: 960px;
            margin-top: 20px;
            margin-bottom: 50px;
        }

        .card {
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .card-header {
            background-color: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            font-weight: 500;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }

        .form-label {
            font-weight: 500;
        }

        .form-control, .form-select {
            border-radius: 8px;
        }

        .btn {
            border-radius: 8px;
        }

        .experiencia-item, .educacion-item, .idioma-item {
            transition: background-color 0.2s;
        }

        .experiencia-item:hover, .educacion-item:hover, .idioma-item:hover {
            background-color: #f8f9fa;
        }
    </style>
{% endblock %}

{% block extra_js %}
    <!-- Cropper.js JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <!-- Scripts personalizados -->
    <script src="{% static 'js/image-cropper.js' %}"></script>
    <script src="{% static 'js/perfil-interesado.js' %}"></script>
{% endblock %}

{% block content %}

<div class="container-fluid px-2 px-sm-3">
    <div class="row g-3 g-md-4">
        <!-- Columna del perfil - MANTENER TAL COMO ESTÁ -->
        <div class="col-12 col-lg-4 order-1">
            <!-- Card de foto y datos básicos -->
            <div class="card mb-3 mb-md-4">
                <div class="card-body text-center p-3 p-md-4">
                    <div class="profile-photo-container mb-3">
                        {% if interesado.foto_perfil %}
                            <img src="{{ interesado.foto_perfil.url }}"
                                 alt="Foto de perfil"
                                 class="profile-photo img-fluid rounded-circle clickeable-photo"
                                 data-bs-toggle="modal"
                                 data-bs-target="#cropperModal">
                        {% else %}
                            <div class="profile-photo-placeholder bg-light rounded-circle d-inline-flex justify-content-center align-items-center clickeable-photo"
                                 data-bs-toggle="modal"
                                 data-bs-target="#cropperModal">
                                <i class="bi bi-person-fill profile-icon"></i>
                            </div>
                        {% endif %}

                    </div>
                    <h4 class="h5 h-md-4 mb-2">{{ interesado.nombre_completo }}</h4>
{#                    <button class="btn btn-outline-primary btn-sm w-100 w-sm-auto"#}
{#                            data-bs-toggle="modal"#}
{#                            data-bs-target="#editarPerfilModal">#}
{#                        <i class="bi bi-pencil-square"></i>#}
{#                        <span class="d-none d-sm-inline">Editar Perfil</span>#}
{#                        <span class="d-sm-none">Editar</span>#}
{#                    </button>#}
                </div>
            </div>

            <!-- Card de información de contacto -->
            <div class="card mb-3 mb-md-4">
                <div class="card-header py-2 py-md-3">
                    <h5 class="mb-0 h6 h-md-5">
                        <i class="bi bi-info-circle"></i>
                        <span class="d-none d-sm-inline">Información de Contacto</span>
                        <span class="d-sm-none">Contacto</span>
                    </h5>
                </div>
                <div class="card-body p-3">
                    <div class="contact-info">
                        <div class="contact-item mb-2 mb-md-3">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-envelope me-2 mt-1 text-primary"></i>
                                <div class="flex-grow-1">
                                    <strong class="d-block d-sm-inline small"></strong>
                                    <span class="text-break text-muted">{{ user.email }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="contact-item mb-2 mb-md-3">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-telephone me-2 mt-1 text-primary"></i>
                                <div class="flex-grow-1">
                                    <strong class="d-block d-sm-inline small"></strong>
                                    {% if interesado.telefono %}
                                        <span class="text-muted">{{ interesado.telefono }}</span>
                                    {% else %}
                                        <span class="text-muted">No especificado</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="contact-item">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-geo-alt me-2 mt-1 text-primary"></i>
                                <div class="flex-grow-1">
                                    <strong class="d-block d-sm-inline small"></strong>
                                    {% if interesado.municipio %}
                                        <span class="text-muted">{{ interesado.ubicacion_completa }}</span>
                                    {% else %}
                                        <span class="text-muted">No especificada</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna del contenido principal - REEMPLAZAR CON CV -->
        <div class="col-12 col-lg-8 order-2">
            <div class="cv-container">
{#                <div class="d-flex justify-content-between align-items-center mb-4">#}
{#                    <h1>Mi Currículum Vitae</h1>#}
{#                </div>#}

                <form id="cvForm" method="post">
                    {% csrf_token %}

                    <!-- Información de Contacto -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-person-fill"></i> Información personal</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="nombre" class="form-label">Nombre(s)</label>
                                    <input type="text" class="form-control" id="nombre" name="nombre" value="{{ interesado.nombre }}" required>
                                </div>

                                <div class="col-md-6">
                                    <label for="apellido_paterno" class="form-label">Apellido Paterno</label>
                                    <input type="text" class="form-control" id="apellido_paterno" name="apellido_paterno" value="{{ interesado.apellido_paterno }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="apellido_materno" class="form-label">Apellido Materno</label>
                                    <input type="text" class="form-control" id="apellido_materno" name="apellido_materno" value="{% if interesado.apellido_materno %}{{ interesado.apellido_materno }}{% endif %}">
                                </div>
                                <div class="col-md-6">
                                    <label for="telefono" class="form-label">Teléfono</label>
                                    <input type="tel" class="form-control" id="telefono" name="telefono" value="{% if interesado.telefono %}{{ interesado.telefono }}{% endif %}">
                                </div>
                                <div class="col-md-6">
                                    <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento</label>
                                    <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento" value="{% if interesado.fecha_nacimiento %}{{ interesado.fecha_nacimiento|date:'Y-m-d' }}{% endif %}">
                                </div>
                                <div class="col-md-6">
                                    <label for="municipio" class="form-label">Municipio</label>
                                    <select class="form-select" id="municipio" name="municipio">
                                        <option value="">Selecciona un municipio...</option>
                                        {% for value, label in interesado.MUNICIPIOS_ESTADO_MEXICO %}
                                            <option value="{{ value }}" {% if interesado.municipio == value %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="codigo_postal" class="form-label">Código Postal</label>
                                    <input type="text" class="form-control" id="codigo_postal" name="codigo_postal" value="{% if interesado.codigo_postal %}{{ interesado.codigo_postal }}{% endif %}" placeholder="Ej: 50000">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen Profesional -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-file-person"></i> Resumen Profesional</h5>
                        </div>
                        <div class="card-body text-justify">
                            <label for="resumen_profesional" class="form-label">Resumen Profesional</label>
                            <textarea class="form-control" id="resumen_profesional" name="resumen_profesional" rows="4" placeholder="Ej: Profesional con 5 años de experiencia en desarrollo web...">{% if curriculum and curriculum.resumen_profesional %}{{ curriculum.resumen_profesional }}{% endif %}</textarea>
                        </div>
                    </div>

                    <!-- Experiencia Laboral -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-briefcase-fill"></i> Experiencia Laboral</h5>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="mostrarModalExperiencia()">
                                <i class="bi bi-plus-circle"></i> Agregar Experiencia
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="experienciaContainer">
                                {% if experiencias %}
                                    {% for experiencia in experiencias %}
                                        <div class="experiencia-item mb-3 p-3 border rounded" data-id="{{ experiencia.id }}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">{{ experiencia.puesto }}</h6>
                                                    <p class="mb-1 text-muted">{{ experiencia.empresa }}</p>
                                                    <p class="mb-1 small">{{ experiencia.periodo_trabajo }}</p>
                                                    <p class="mb-0 small">{{ experiencia.descripcion|truncatewords:20 }}</p>
                                                </div>
                                                <div class="btn-group-vertical">
                                                    <button type="button" class="btn btn-sm btn-outline-primary mb-1"
                                                        onclick="editarExperiencia(
                                                            {{ experiencia.id }},
                                                            '{{ experiencia.puesto|escapejs }}',
                                                            '{{ experiencia.empresa|escapejs }}',
                                                            '{{ experiencia.fecha_inicio|date:"Y-m-d" }}',
                                                            '{% if experiencia.fecha_fin %}{{ experiencia.fecha_fin|date:"Y-m-d" }}{% endif %}',
                                                            {{ experiencia.actual|yesno:"true,false" }},
                                                            '{{ experiencia.descripcion|escapejs }}'
                                                        )">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarExperiencia({{ experiencia.id }})">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted text-center">No hay experiencias laborales registradas.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Educación -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-mortarboard-fill"></i> Educación y Formación</h5>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="mostrarModalEducacion()">
                                <i class="bi bi-plus-circle"></i> Agregar Formación
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="educacionContainer">
                                {% if educaciones %}
                                    {% for educacion in educaciones %}
                                        <div class="educacion-item mb-3 p-3 border rounded" data-id="{{ educacion.id }}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">{{ educacion.titulo }}</h6>
                                                    <p class="mb-1 text-muted">{{ educacion.institucion }}</p>
                                                    <p class="mb-1 small">{{ educacion.periodo_estudio }}</p>
                                                    {% if educacion.descripcion %}
                                                        <p class="mb-0 small">{{ educacion.descripcion|truncatewords:20 }}</p>
                                                    {% endif %}
                                                </div>
                                                <div class="btn-group-vertical">
                                                    <button type="button" class="btn btn-sm btn-outline-primary mb-1"
                                                        onclick="editarEducacion({{ educacion.id }}, '{{ educacion.titulo|escapejs }}', '{{ educacion.institucion|escapejs }}', '{{ educacion.fecha_inicio|date:"Y-m-d" }}', '{% if educacion.fecha_fin %}{{ educacion.fecha_fin|date:"Y-m-d" }}{% endif %}', '{{ educacion.descripcion|escapejs }}')">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarEducacion({{ educacion.id }})">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted text-center">No hay educación registrada.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Habilidades -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-tools"></i> Habilidades Técnicas</h5>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="mostrarModalHabilidad()">
                                <i class="bi bi-plus-circle"></i> Agregar Habilidad
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="habilidadesContainer">
                                {% if habilidades %}
                                    {% for habilidad in habilidades %}
                                        <span class="badge bg-primary me-2 mb-2 p-2" data-id="{{ habilidad.id }}">
                                            {{ habilidad.habilidad.nombre }} - {{ habilidad.get_nivel_display }}
                                            <button type="button" class="btn-close btn-close-white ms-2" onclick="eliminarHabilidad({{ habilidad.id }})"></button>
                                        </span>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted text-center">No hay habilidades registradas.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Idiomas -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-translate"></i> Idiomas</h5>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="mostrarModalIdioma()">
                                <i class="bi bi-plus-circle"></i> Agregar Idioma
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="idiomasContainer">
                                {% if idiomas %}
                                    {% for idioma in idiomas %}
                                        <div class="idioma-item mb-2 p-2 border rounded d-flex justify-content-between align-items-center" data-id="{{ idioma.id }}">
                                            <div>
                                                <strong>{{ idioma.idioma }}</strong> - {{ idioma.nivel_general }}
                                                <small class="text-muted d-block">
                                                    Lectura: {{ idioma.get_nivel_lectura_display }},
                                                    Escritura: {{ idioma.get_nivel_escritura_display }},
                                                    Conversación: {{ idioma.get_nivel_conversacion_display }}
                                                </small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarIdioma({{ idioma.id }})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted text-center">No hay idiomas registrados.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="text-end mt-4 mb-5">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-save"></i> Guardar CV Completo
                        </button>
                        {% if tiene_cv %}
                            <a href="{% url 'descargar_cv_pdf' %}" class="btn btn-outline-primary">
                                <i class="bi bi-download"></i> Descargar PDF
                            </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar perfil con cropper integrado -->
<div class="modal fade" id="editarPerfilModal" tabindex="-1" aria-labelledby="editarPerfilModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title h6 h-md-5 text-white" id="editarPerfilModalLabel">Editar Perfil</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editarPerfilForm" enctype="multipart/form-data" data-update-url="{% url 'actualizar_perfil_ajax' %}">
                    {% csrf_token %}

                    <!-- Preview de foto -->
                    <div class="text-center mb-4">
                        <div class="profile-photo-container mx-auto" id="photoPreviewContainer">
                            {% if interesado.foto_perfil %}
                                <img src="{{ interesado.foto_perfil.url }}" alt="Foto de perfil" class="profile-photo" id="photoPreview">
                            {% else %}
                                <i class="bi bi-person-circle profile-photo-placeholder" id="photoPlaceholder"></i>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-12">
                            <label for="foto_perfil" class="form-label">Foto de Perfil</label>
                            <div class="d-flex gap-2">
                                <input type="file" class="form-control" id="foto_perfil" name="foto_perfil" accept=".jpg,.jpeg" style="display: none;">
                                <button type="button" class="btn btn-outline-primary flex-grow-1" data-bs-toggle="modal" data-bs-target="#cropperModal">
                                    <i class="bi bi-camera"></i> Cargar foto de Perfil
                                </button>
                            </div>
                            <div class="form-text">Sube una imagen en formato JPG o JPEG para seguir.</div>
                        </div>

                        <div class="col-12">
                            <label for="nombre" class="form-label">Nombre(s)</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" value="{{ interesado.nombre }}" required>
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="apellido_paterno" class="form-label">Apellido Paterno</label>
                            <input type="text" class="form-control" id="apellido_paterno" name="apellido_paterno" value="{{ interesado.apellido_paterno }}" required>
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="apellido_materno" class="form-label">Apellido Materno</label>
                            <input type="text" class="form-control" id="apellido_materno" name="apellido_materno" value="{% if interesado.apellido_materno %}{{ interesado.apellido_materno }}{% endif %}">
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="telefono" name="telefono" value="{% if interesado.telefono %}{{ interesado.telefono }}{% endif %}">
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento" value="{% if interesado.fecha_nacimiento %}{{ interesado.fecha_nacimiento|date:'Y-m-d' }}{% endif %}">
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="municipio" class="form-label">Municipio</label>
                            <select class="form-select" id="municipio" name="municipio">
                                <option value="">Selecciona un municipio...</option>
                                {% for value, label in interesado.MUNICIPIOS_ESTADO_MEXICO %}
                                    <option value="{{ value }}" {% if interesado.municipio == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="codigo_postal" class="form-label">Código Postal</label>
                            <input type="text" class="form-control" id="codigo_postal" name="codigo_postal" value="{% if interesado.codigo_postal %}{{ interesado.codigo_postal }}{% endif %}" placeholder="Ej: 50000">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer flex-column flex-sm-row">
                <button type="button" class="btn btn-secondary w-100 w-sm-auto mb-2 mb-sm-0 me-sm-2" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary w-100 w-sm-auto" id="guardarPerfilBtn">
                    <span class="btn-text">Guardar Cambios</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal del Cropper -->
<div class="modal fade" id="cropperModal" tabindex="-1" aria-labelledby="cropperModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropperModalLabel">Recortar Imagen de Perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body cropper-modal-body">

                <!-- Paso 1: Seleccionar imagen -->
                <div id="selectStep" class="cropper-step active">
                    <div class="cropper-instructions">
                        <h6><i class="bi bi-info-circle"></i> Instrucciones</h6>
                        <p>Selecciona una imagen JPG para tu foto de perfil. Podrás recortarla en el siguiente paso.</p>
                    </div>

                    <div class="drop-zone" id="dropZone">
                        <i class="bi bi-cloud-upload"></i>
                        <p class="mb-2"><strong>Seleccione </strong> o arrastre una imagen en formato compatible</p>
                        <p class="small text-muted">Formatos permitidos: JPG y JPEG.• Tamaño Máximo 5MB</p>
                    </div>
                </div>

                <!-- Paso 2: Recortar imagen -->
                <div id="cropStep" class="cropper-step">
                    <div class="cropper-instructions">
                        <h6><i class="bi bi-scissors"></i> Recortar Imagen</h6>
                        <p>Ajusta el área de recorte para tu foto de perfil.</p>
                    </div>
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="image-cropper-container">
                                <img id="cropperImage" src="" alt="Imagen a recortar" style="max-width: 100%; display: none;">
                            </div>
                            <div class="cropper-controls">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="resetCropButton">
                                    <i class="bi bi-arrow-clockwise"></i> Reiniciar
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" id="cancelCropButton">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </button>
                                <button type="button" class="btn btn-success btn-sm" id="cropButton">
                                    <i class="bi bi-check-circle"></i> Recortar y Usar
                                </button>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="text-center">
                                <h6>Vista Previa</h6>
                                <div class="crop-preview" id="cropPreview"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modales para CV (igual que en crear_editar_cv.html) -->
<!-- Modal para Experiencia Laboral -->
<div class="modal fade" id="experienciaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Experiencia Laboral</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="experienciaForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Puesto</label>
                            <input type="text" class="form-control" name="puesto" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Empresa</label>
                            <input type="text" class="form-control" name="empresa" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha de Inicio</label>
                            <input type="date" class="form-control" name="fecha_inicio" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha de Fin</label>
                            <input type="date" class="form-control" name="fecha_fin">
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="actual" id="actualCheck">
                                <label class="form-check-label" for="actualCheck">
                                    Es mi trabajo actual
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Funciones y Responsabilidades</label>
                            <textarea class="form-control" name="descripcion" rows="3" required></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarExperiencia()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Educación -->
<div class="modal fade" id="educacionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Educación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="educacionForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Título Obtenido / Nivel</label>
                            <input type="text" class="form-control" name="titulo" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Institución Educativa</label>
                            <input type="text" class="form-control" name="institucion" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha de Inicio</label>
                            <input type="date" class="form-control" name="fecha_inicio" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha de Fin</label>
                            <input type="date" class="form-control" name="fecha_fin">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Descripción (opcional)</label>
                            <textarea class="form-control" name="descripcion" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarEducacion()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Habilidades -->
<div class="modal fade" id="habilidadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Habilidad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="habilidadForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Habilidad</label>
                        <input type="text" class="form-control" name="nombre_habilidad" placeholder="Ej: JavaScript, Liderazgo" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nivel de Dominio</label>
                        <select class="form-select" name="nivel" required>
                            <option value="">Selecciona un nivel...</option>
                            <option value="basico">Básico</option>
                            <option value="intermedio">Intermedio</option>
                            <option value="avanzado">Avanzado</option>
                            <option value="experto">Experto</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarHabilidad()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Idiomas -->
<div class="modal fade" id="idiomaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Idioma</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="idiomaForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Idioma</label>
                        <input type="text" class="form-control" name="idioma" placeholder="Ej: Inglés" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nivel de Lectura</label>
                        <select class="form-select" name="nivel_lectura" required>
                            <option value="">Selecciona un nivel...</option>
                            <option value="A1">A1 - Principiante</option>
                            <option value="A2">A2 - Elemental</option>
                            <option value="B1">B1 - Intermedio</option>
                            <option value="B2">B2 - Intermedio Alto</option>
                            <option value="C1">C1 - Avanzado</option>
                            <option value="C2">C2 - Maestría</option>
                            <option value="nativo">Nativo</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nivel de Escritura</label>
                        <select class="form-select" name="nivel_escritura" required>
                            <option value="">Selecciona un nivel...</option>
                            <option value="A1">A1 - Principiante</option>
                            <option value="A2">A2 - Elemental</option>
                            <option value="B1">B1 - Intermedio</option>
                            <option value="B2">B2 - Intermedio Alto</option>
                            <option value="C1">C1 - Avanzado</option>
                            <option value="C2">C2 - Maestría</option>
                            <option value="nativo">Nativo</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nivel de Conversación</label>
                        <select class="form-select" name="nivel_conversacion" required>
                            <option value="">Selecciona un nivel...</option>
                            <option value="A1">A1 - Principiante</option>
                            <option value="A2">A2 - Elemental</option>
                            <option value="B1">B1 - Intermedio</option>
                            <option value="B2">B2 - Intermedio Alto</option>
                            <option value="C1">C1 - Avanzado</option>
                            <option value="C2">C2 - Maestría</option>
                            <option value="nativo">Nativo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarIdioma()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript del CV (igual que en crear_editar_cv.html)
// Variables globales para controlar edición
let experienciaEditandoId = null;
let educacionEditandoId = null;

// =========================
// EXPERIENCIA LABORAL
// =========================
function mostrarModalExperiencia() {
    experienciaEditandoId = null;
    document.querySelector('#experienciaModal .modal-title').textContent = 'Agregar Experiencia Laboral';
    document.getElementById('experienciaForm').reset();
    document.querySelector('#experienciaForm input[name="fecha_fin"]').disabled = false;
    new bootstrap.Modal(document.getElementById('experienciaModal')).show();
}

function editarExperiencia(id, puesto, empresa, fechaInicio, fechaFin, actual, descripcion) {
    experienciaEditandoId = id;

    document.querySelector('#experienciaForm input[name="puesto"]').value = puesto;
    document.querySelector('#experienciaForm input[name="empresa"]').value = empresa;
    document.querySelector('#experienciaForm input[name="fecha_inicio"]').value = fechaInicio;
    document.querySelector('#experienciaForm input[name="fecha_fin"]').value = fechaFin || '';
    document.querySelector('#experienciaForm input[name="actual"]').checked = actual;
    document.querySelector('#experienciaForm textarea[name="descripcion"]').value = descripcion;

    const fechaFinInput = document.querySelector('#experienciaForm input[name="fecha_fin"]');
    fechaFinInput.disabled = actual;

    document.querySelector('#experienciaModal .modal-title').textContent = 'Editar Experiencia Laboral';
    new bootstrap.Modal(document.getElementById('experienciaModal')).show();
}

function guardarExperiencia() {
    const form = document.getElementById('experienciaForm');
    const formData = new FormData(form);

    let url = experienciaEditandoId ?
        `/ajax/experiencia/editar/${experienciaEditandoId}/` :
        '/ajax/experiencia/agregar/';

    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('experienciaModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + JSON.stringify(data.errors || data.error));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar la experiencia');
    });
}

function eliminarExperiencia(id) {
    if (confirm('¿Estás seguro de eliminar esta experiencia?')) {
        fetch(`/ajax/experiencia/eliminar/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al eliminar: ' + data.error);
            }
        });
    }
}

// =========================
// EDUCACIÓN
// =========================
function mostrarModalEducacion() {
    educacionEditandoId = null;
    document.querySelector('#educacionModal .modal-title').textContent = 'Agregar Educación';
    document.getElementById('educacionForm').reset();
    new bootstrap.Modal(document.getElementById('educacionModal')).show();
}

function editarEducacion(id, titulo, institucion, fechaInicio, fechaFin, descripcion) {
    educacionEditandoId = id;

    document.querySelector('#educacionForm input[name="titulo"]').value = titulo;
    document.querySelector('#educacionForm input[name="institucion"]').value = institucion;
    document.querySelector('#educacionForm input[name="fecha_inicio"]').value = fechaInicio;
    document.querySelector('#educacionForm input[name="fecha_fin"]').value = fechaFin || '';
    document.querySelector('#educacionForm textarea[name="descripcion"]').value = descripcion || '';

    document.querySelector('#educacionModal .modal-title').textContent = 'Editar Educación';
    new bootstrap.Modal(document.getElementById('educacionModal')).show();
}

function guardarEducacion() {
    const form = document.getElementById('educacionForm');
    const formData = new FormData(form);

    let url = '/ajax/educacion/agregar/'; // Solo creación por ahora

    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('educacionModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + JSON.stringify(data.errors || data.error));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar la educación');
    });
}

function eliminarEducacion(id) {
    if (confirm('¿Estás seguro de eliminar esta educación?')) {
        fetch(`/ajax/educacion/eliminar/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al eliminar: ' + data.error);
            }
        });
    }
}

// =========================
// HABILIDADES
// =========================
function mostrarModalHabilidad() {
    document.getElementById('habilidadForm').reset();
    new bootstrap.Modal(document.getElementById('habilidadModal')).show();
}

function guardarHabilidad() {
    const form = document.getElementById('habilidadForm');
    const formData = new FormData(form);

    fetch('/ajax/habilidad/agregar/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('habilidadModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + JSON.stringify(data.errors || data.error));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar la habilidad');
    });
}

function eliminarHabilidad(id) {
    if (confirm('¿Estás seguro de eliminar esta habilidad?')) {
        fetch(`/ajax/habilidad/eliminar/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al eliminar: ' + data.error);
            }
        });
    }
}

// =========================
// IDIOMAS
// =========================
function mostrarModalIdioma() {
    document.getElementById('idiomaForm').reset();
    new bootstrap.Modal(document.getElementById('idiomaModal')).show();
}

function guardarIdioma() {
    const form = document.getElementById('idiomaForm');
    const formData = new FormData(form);

    fetch('/ajax/idioma/agregar/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('idiomaModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + JSON.stringify(data.errors || data.error));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar el idioma');
    });
}

function eliminarIdioma(id) {
    if (confirm('¿Estás seguro de eliminar este idioma?')) {
        fetch(`/ajax/idioma/eliminar/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al eliminar: ' + data.error);
            }
        });
    }
}

// =========================
// EVENT LISTENERS
// =========================
document.addEventListener('DOMContentLoaded', function() {
    // Control de trabajo actual para experiencia
    const actualCheck = document.getElementById('actualCheck');
    if (actualCheck) {
        actualCheck.addEventListener('change', function() {
            const fechaFin = document.querySelector('#experienciaForm input[name="fecha_fin"]');
            if (this.checked) {
                fechaFin.disabled = true;
                fechaFin.value = '';
            } else {
                fechaFin.disabled = false;
            }
        });
    }

    // Limpiar modales al cerrar
    document.getElementById('experienciaModal')?.addEventListener('hidden.bs.modal', function () {
        experienciaEditandoId = null;
        document.querySelector('#experienciaModal .modal-title').textContent = 'Agregar Experiencia Laboral';
    });

    document.getElementById('educacionModal')?.addEventListener('hidden.bs.modal', function () {
        educacionEditandoId = null;
        document.querySelector('#educacionModal .modal-title').textContent = 'Agregar Educación';
    });
});
</script>

{% endblock %}